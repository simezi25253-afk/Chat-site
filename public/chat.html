<!-- 省略: <head> は前回の chat.html と同じ -->

<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  const urlParams = new URLSearchParams(window.location.search);
  const room = urlParams.get('room');
  const password = urlParams.get('password') || '';

  // ✅ ニックネームを localStorage から取得 or 入力
  let nickname = localStorage.getItem('nickname') || prompt('ニックネームを入力してください');
  if (!nickname) {
    window.location.href = '/home.html';
  } else {
    localStorage.setItem('nickname', nickname); // 保存
  }

  document.getElementById('room-name').textContent = `ルーム: ${room}`;
  let leaderId = null;
  let myUserId = null;

  socket.emit('joinRoom', { room, password, nickname }, (res) => {
    if (!res.ok) {
      alert(res.error || 'ルーム参加に失敗しました');
      window.location.href = '/home.html';
      return;
    }

    myUserId = res.userId;
    localStorage.setItem('lastRoom', room); // ✅ ルーム名保存

    if (res.messages) {
      res.messages.forEach(msg => addMessage(msg));
    }

    if (res.isLeader) {
      document.title += ' ⭐';
      document.getElementById('change-password-btn').style.display = 'inline-block';
    }
  });

  // 以下は前回の chat.html と同じ（省略可能）
</script>
