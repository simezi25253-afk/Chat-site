<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>チャットルーム</title>
  <link rel="stylesheet" href="/style.css" />
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <h1 id="room-title">チャットルーム</h1>
  <div id="chat-container">
    <div id="messages"></div>
    <form id="message-form">
      <input type="text" id="message-input" placeholder="メッセージを入力..." autocomplete="off" required />
      <button type="submit">送信</button>
    </form>
  </div>

  <div id="user-list-container">
    <h3>オンラインユーザー</h3>
    <ul id="user-list"></ul>
  </div>

  <script>
    const socket = io();
    const urlParams = new URLSearchParams(window.location.search);
    const room = urlParams.get('room');
    const nickname = localStorage.getItem('nickname') || '名無し';

    document.getElementById('room-title').textContent = `ルーム: ${room}`;

    let leaderId = null;

    socket.emit('joinRoom', { room, password: '', nickname }, (res) => {
      if (!res.ok) {
        alert(res.error || 'ルーム参加に失敗しました');
        window.location.href = '/home.html';
        return;
      }

      res.messages.forEach(addMessage);
    });

    socket.on('leader', (id) => {
      leaderId = id;
    });

    socket.on('onlineUsers', (nicknames) => {
      const userList = document.getElementById('user-list');
      userList.innerHTML = '';
      for (const [socketId, name] of Object.entries(nicknames)) {
        const li = document.createElement('li');
        li.textContent = socketId === leaderId ? `${name} ⭐︎` : name;
        userList.appendChild(li);
      }
    });

    const form = document.getElementById('message-form');
    const input = document.getElementById('message-input');
    const messages = document.getElementById('messages');

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (text) {
        socket.emit('newMessage', { room, text });
        input.value = '';
      }
    });

    socket.on('newMessage', (msg) => {
      addMessage(msg);
    });

    function addMessage(msg) {
      const div = document.createElement('div');
      const time = new Date(msg.ts).toLocaleTimeString();
      const isLeader = msg.userId === leaderId;
      const displayName = isLeader ? `${msg.nickname} ⭐︎` : msg.nickname;
      div.textContent = `[${time}] ${displayName}: ${msg.text}`;
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }
  </script>
</body>
</html>
